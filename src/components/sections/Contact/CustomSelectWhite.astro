---
interface Props {
  id: string;
  label: string;
  options: string[];
}

const { id, label, options } = Astro.props;
---

<div class="custom-select-wrapper">
  <label for={id} class="custom-select-label">{label}</label>
  <div class="custom-select" data-select={id}>
    <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false">
      <span class="custom-select-value">{options[0]}</span>
      <svg class="custom-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <ul class="custom-select-dropdown" role="listbox">
      {options.map((option, index) => (
        <li
          class={`custom-select-option ${index === 0 ? 'selected' : ''}`}
          role="option"
          aria-selected={index === 0 ? "true" : "false"}
          data-value={option}
        >
          {option}
        </li>
      ))}
    </ul>
    <input type="hidden" name={id} id={id} value={options[0]} />
  </div>
</div>

<style>
  .custom-select-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .custom-select-label {
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    color: var(--text-secondary-dark);
  }

  .custom-select {
    position: relative;
    width: 100%;
  }

  .custom-select-trigger {
    width: 100%;
    background-color: var(--background-light);
    color: #374151;
    border: 2px solid transparent;
    padding: var(--space-3) var(--space-4);
    outline: none;
    font-weight: var(--font-medium);
    font-family: var(--font-body);
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    text-align: left;
  }

  .custom-select-trigger:hover {
    ring: 2px;
    ring-color: var(--primary);
  }

  .custom-select-trigger:focus,
  .custom-select.open .custom-select-trigger {
    ring: 2px;
    ring-color: var(--primary);
    border-color: transparent;
  }

  /* Estado de erro - borda vermelha */
  .custom-select.error .custom-select-trigger {
    border-color: #ef4444;
    box-shadow: 0 0 0 1px #ef4444;
  }

  .custom-select.error .custom-select-trigger:focus,
  .custom-select.error.open .custom-select-trigger {
    border-color: #ef4444;
    ring-color: #ef4444;
  }

  .custom-select-value {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .custom-select-arrow {
    flex-shrink: 0;
    margin-left: var(--space-2);
    color: #6b7280;
    transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1), color 300ms;
  }

  .custom-select.open .custom-select-arrow {
    transform: rotate(180deg);
    color: var(--primary);
  }

  .custom-select-dropdown {
    position: absolute;
    top: calc(100% + 0.25rem);
    left: 0;
    right: 0;
    background-color: var(--background-light);
    border: 1px solid #e5e7eb;
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform-origin: top;
    transform: scaleY(0);
    transition: max-height 300ms cubic-bezier(0.4, 0, 0.2, 1),
                opacity 300ms cubic-bezier(0.4, 0, 0.2, 1),
                transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 100;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .custom-select.open .custom-select-dropdown {
    max-height: 15rem;
    opacity: 1;
    transform: scaleY(1);
    overflow-y: auto;
  }

  .custom-select-option {
    padding: var(--space-3) var(--space-4);
    color: #374151;
    cursor: pointer;
    transition: background-color 200ms, color 200ms;
    border-bottom: 1px solid #f3f4f6;
  }

  .custom-select-option:last-child {
    border-bottom: none;
  }

  .custom-select-option:hover {
    background-color: rgba(255, 107, 0, 0.1);
    color: var(--primary);
  }

  .custom-select-option.selected {
    background-color: rgba(255, 107, 0, 0.15);
    color: var(--primary);
    font-weight: var(--font-bold);
  }

  /* Scrollbar para a lista */
  .custom-select-dropdown::-webkit-scrollbar {
    width: 6px;
  }

  .custom-select-dropdown::-webkit-scrollbar-track {
    background: #f9fafb;
  }

  .custom-select-dropdown::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
  }

  .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const customSelects = document.querySelectorAll('.custom-select');

    customSelects.forEach((selectElement) => {
      const trigger = selectElement.querySelector('.custom-select-trigger') as HTMLButtonElement;
      const dropdown = selectElement.querySelector('.custom-select-dropdown') as HTMLUListElement;
      const options = selectElement.querySelectorAll('.custom-select-option');
      const valueDisplay = selectElement.querySelector('.custom-select-value') as HTMLSpanElement;
      const hiddenInput = selectElement.querySelector('input[type="hidden"]') as HTMLInputElement;

      // Alternar exibição do dropdown
      trigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = selectElement.classList.contains('open');

        // Fechar todos os outros selects
        customSelects.forEach(s => s.classList.remove('open'));

        // Alternar o dropdown atual
        if (!isOpen) {
          selectElement.classList.add('open');
          trigger.setAttribute('aria-expanded', 'true');
        } else {
          selectElement.classList.remove('open');
          trigger.setAttribute('aria-expanded', 'false');
        }
      });

      // Selecionar opção
      options.forEach((option) => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = option.getAttribute('data-value');

          if (value) {
            // Atualizar exibição
            valueDisplay.textContent = value;

            // Atualizar campo oculto
            hiddenInput.value = value;

            // Atualizar estado selecionado
            options.forEach(opt => {
              opt.classList.remove('selected');
              opt.setAttribute('aria-selected', 'false');
            });
            option.classList.add('selected');
            option.setAttribute('aria-selected', 'true');

            // Remover erro se houver
            selectElement.classList.remove('error');

            // Fechar dropdown
            selectElement.classList.remove('open');
            trigger.setAttribute('aria-expanded', 'false');
          }
        });
      });

      // Fechar ao clicar fora
      document.addEventListener('click', () => {
        selectElement.classList.remove('open');
        trigger?.setAttribute('aria-expanded', 'false');
      });

      // Navegação por teclado
      trigger?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          trigger.click();
        }
      });

      dropdown?.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          selectElement.classList.remove('open');
          trigger?.setAttribute('aria-expanded', 'false');
          trigger?.focus();
        }
      });
    });
  });
</script>
