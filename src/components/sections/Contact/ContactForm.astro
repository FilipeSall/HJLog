---
import { Icon } from "astro-icon/components";
import CustomSelectWhite from "./CustomSelectWhite.astro";

interface FormFields {
  name: {
    label: string;
    placeholder: string;
  };
  email: {
    label: string;
    placeholder: string;
  };
  subject: {
    label: string;
    options: string[];
  };
  message: {
    label: string;
    placeholder: string;
  };
}

interface Props {
  title: string;
  fields: FormFields;
  submitLabel: string;
}

const { title, fields, submitLabel } = Astro.props;
---

<div class="contact-form-wrapper">
  <h2 class="form-title">{title}</h2>
  <form class="contact-form">
    <div class="form-row">
      <div class="form-field">
        <label class="form-label" for="name">{fields.name.label}</label>
        <input
          class="form-input"
          id="name"
          name="name"
          placeholder={fields.name.placeholder}
          type="text"
          required
        />
      </div>
      <div class="form-field">
        <label class="form-label" for="email">{fields.email.label}</label>
        <input
          class="form-input"
          id="email"
          name="email"
          placeholder={fields.email.placeholder}
          type="email"
          required
        />
      </div>
    </div>

    <div class="form-field">
      <CustomSelectWhite
        id="subject"
        label={fields.subject.label}
        options={fields.subject.options}
      />
    </div>

    <div class="form-field">
      <label class="form-label" for="message">{fields.message.label}</label>
      <textarea
        class="form-textarea"
        id="message"
        name="message"
        placeholder={fields.message.placeholder}
        rows="5"
        required
      ></textarea>
    </div>

    <button class="form-submit" type="submit">
      {submitLabel}
      <Icon name="mdi:send" size={20} class="submit-icon" />
    </button>
  </form>
</div>

<style>
  .contact-form-wrapper {
    background-color: rgba(42, 42, 42, 0.4);
    padding: var(--space-8);
    border: 1px solid var(--surface-dark);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    transition: border-color 0.3s ease;
  }

  /* Animação de piscada laranja */
  .contact-form-wrapper.form-flash {
    animation: flashBorder 3s ease-in-out;
  }

  @keyframes flashBorder {
    0%, 100% {
      border-color: var(--surface-dark);
      box-shadow: none;
    }
    10%, 30%, 50%, 70%, 90% {
      border-color: var(--primary);
      box-shadow: 0 0 20px rgba(255, 107, 0, 0.5);
    }
    20%, 40%, 60%, 80% {
      border-color: var(--surface-dark);
      box-shadow: none;
    }
  }

  @media (min-width: 768px) {
    .contact-form-wrapper {
      padding: var(--space-10);
    }
  }

  .form-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary-dark);
    text-transform: uppercase;
    margin-bottom: var(--space-6);
  }

  .contact-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-5);
  }

  @media (min-width: 768px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-label {
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    color: var(--text-secondary-dark);
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    background-color: var(--background-light);
    color: var(--background-dark);
    padding: var(--space-3) var(--space-4);
    outline: none;
    border: 2px solid transparent;
    font-weight: var(--font-medium);
    font-family: var(--font-body);
    transition: all var(--transition-base);
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    ring: 2px;
    ring-color: var(--primary);
    border-color: transparent;
  }

  /* Estado de erro - borda vermelha */
  .form-input.error,
  .form-textarea.error {
    border-color: #ef4444;
    box-shadow: 0 0 0 1px #ef4444;
  }

  .form-input.error:focus,
  .form-textarea.error:focus {
    border-color: #ef4444;
    ring-color: #ef4444;
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: #6b7280;
  }

  .form-select {
    color: #374151;
  }

  .form-textarea {
    resize: none;
  }

  .form-submit {
    margin-top: var(--space-4);
    width: 100%;
    background-color: var(--primary);
    color: var(--background-dark);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    padding: var(--space-4) var(--space-8);
    border: none;
    cursor: pointer;
    font-family: var(--font-display);
    transition: background-color var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
  }

  .form-submit:hover {
    background-color: var(--white);
  }

  .submit-icon {
    transition: transform var(--transition-base);
  }

  .form-submit:hover .submit-icon {
    transform: translateX(0.25rem);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.contact-form') as HTMLFormElement;
    const nameInput = document.getElementById('name') as HTMLInputElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const messageInput = document.getElementById('message') as HTMLTextAreaElement;

    if (!form) return;

    const validateField = (input: HTMLInputElement | HTMLTextAreaElement): boolean => {
      const value = input.value.trim();

      if (!value) {
        input.classList.add('error');
        return false;
      }

      if (input.type === 'email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          input.classList.add('error');
          return false;
        }
      }

      input.classList.remove('error');
      return true;
    };

    const addBlurValidation = (input: HTMLInputElement | HTMLTextAreaElement) => {
      input.addEventListener('blur', () => {
        validateField(input);
      });

      input.addEventListener('input', () => {
        if (input.classList.contains('error') && input.value.trim()) {
          validateField(input);
        }
      });
    };

    if (nameInput) addBlurValidation(nameInput);
    if (emailInput) addBlurValidation(emailInput);
    if (messageInput) addBlurValidation(messageInput);

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const subjectHiddenInput = document.querySelector('input[name="subject"]') as HTMLInputElement;
      const subject = subjectHiddenInput?.value || '';

      const isNameValid = validateField(nameInput);
      const isEmailValid = validateField(emailInput);
      const isMessageValid = validateField(messageInput);


      if (!isNameValid || !isEmailValid || !isMessageValid || !subject) {
        return;
      }

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const message = messageInput.value.trim();

      // Obter data e hora atual formatada
      const now = new Date();
      const dataHora = now.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Montar corpo do email formatado e estruturado
      const emailBody = `
═══════════════════════════════════════════════════════
          NOVO CONTATO RECEBIDO VIA SITE
═══════════════════════════════════════════════════════

TIPO: Contato Geral

DADOS DO CLIENTE:
  • Nome: ${name}
  • E-mail: ${email}
  • Assunto: ${subject}

DATA/HORA:
  ${dataHora}

───────────────────────────────────────────────────────
MENSAGEM:
───────────────────────────────────────────────────────

${message}

───────────────────────────────────────────────────────

AÇÕES RECOMENDADAS:
→ Responder para: ${email}
→ Prioridade: ${subject.toLowerCase().includes('urgente') ? 'ALTA' : 'Normal'}

═══════════════════════════════════════════════════════
Este email foi gerado automaticamente pelo formulário
de contato do site www.hjlogtransportes.com.br
═══════════════════════════════════════════════════════
      `.trim();

      // Criar link mailto com assunto mais descritivo
      const mailtoLink = `mailto:adm@hjlogtransportes.com.br?subject=${encodeURIComponent(`[CONTATO SITE] ${subject} - ${name}`)}&body=${encodeURIComponent(emailBody)}`;

      // Abrir cliente de email
      window.location.href = mailtoLink;

      // Limpar formulário após envio
      form.reset();

      // Remover classes de erro após reset
      nameInput.classList.remove('error');
      emailInput.classList.remove('error');
      messageInput.classList.remove('error');
    });
  });
</script>
